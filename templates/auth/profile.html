{% extends 'base.html' %}
{% load static %}

{% block title %}{{ user.username }}'s Profile | Lumos Career{% endblock %}

{% block content %}
<div class="container" style="padding-top: 60px; padding-bottom: 80px;">
    
    <!-- Profile Header -->
    <div class="card" style="margin-bottom: 30px; display: flex; align-items: center; gap: 30px; flex-wrap: wrap;">
        <div class="profile-avatar-large" style="width: 120px; height: 120px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; color: white; font-weight: 700;">
            {{ user.username|slice:":1"|upper }}
        </div>
        
        <div style="flex: 1;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h1 style="margin-bottom: 10px;">{{ user.username }}</h1>
                    {% if profile.bio %}
                        <p style="color: var(--text-muted); font-size: 1.1rem; max-width: 600px; margin-bottom: 20px;">{{ profile.bio }}</p>
                    {% else %}
                        <p style="color: var(--text-muted); font-style: italic; margin-bottom: 20px;">No bio added yet.</p>
                    {% endif %}
                </div>
                <a href="{% url 'edit_profile' %}" style="display: inline-block; padding: 8px 20px; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-muted); font-size: 0.9rem; text-decoration: none; transition: all 0.2s;" onmouseover="this.style.color='var(--primary-color)'; this.style.borderColor='var(--primary-color)'" onmouseout="this.style.color='var(--text-muted)'; this.style.borderColor='var(--border-color)'">
                    Edit Profile
                </a>
            </div>

            <!-- Social Links -->
            <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                {% if profile.linkedin_url %}
                    <a href="{{ profile.linkedin_url }}" target="_blank" class="tag" style="text-decoration: none; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; background: rgba(255, 255, 255, 0.05); color: #fff; border: 1px solid #fff;">LinkedIn â†—</a>
                {% endif %}
                {% if profile.github_url %}
                    <a href="{{ profile.github_url }}" target="_blank" class="tag" style="text-decoration: none; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; background: rgba(255, 255, 255, 0.05); color: #fff; border: 1px solid #fff;">GitHub â†—</a>
                {% endif %}
                {% if profile.leetcode_url %}
                    <a href="{{ profile.leetcode_url }}" target="_blank" class="tag" style="text-decoration: none; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; background: rgba(255, 255, 255, 0.05); color: #fff; border: 1px solid #fff;">LeetCode â†—</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Dashboard Tabs -->
    <div class="dashboard-tabs" style="margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 0;">
        <button class="tab-btn active" onclick="openTab(event, 'overview')" style="padding: 15px 25px; background: none; border: none; border-bottom: 2px solid var(--primary-color); color: var(--primary-color); font-weight: 500; cursor: pointer;">Overview</button>
        <button class="tab-btn" onclick="openTab(event, 'career-paths')" style="padding: 15px 25px; background: none; border: none; color: var(--text-muted); font-weight: 500; cursor: pointer;">Career Paths</button>
        <button class="tab-btn" onclick="openTab(event, 'companies')" style="padding: 15px 25px; background: none; border: none; color: var(--text-muted); font-weight: 500; cursor: pointer;">Saved Companies</button>
        <button class="tab-btn" onclick="openTab(event, 'interviews')" style="padding: 15px 25px; background: none; border: none; color: var(--text-muted); font-weight: 500; cursor: pointer;">Interview History</button>
    </div>

    <!-- Tab Content: Overview -->
    <div id="overview" class="tab-content active" style="display: block;">
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
            
            <!-- Left Column -->
            <div style="display: flex; flex-direction: column; gap: 30px;">
                <!-- Resume Section -->
                <div class="card">
                    <h3 style="margin-bottom: 20px;">Resume</h3>
                    {% if profile.filename %}
                    <div style="background: var(--background-input); padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 2rem;">ðŸ“„</span>
                        <div>
                            <div style="font-weight: 500; margin-bottom: 5px;">{{ profile.filename }}</div>
                            <a href="{{ profile.resume_file.url }}" target="_blank" style="font-size: 0.85rem; color: var(--primary-color);">View Resume</a>
                        </div>
                    </div>
                    {% elif profile.resume_text %}
                    <div style="background: var(--background-input); padding: 15px; border-radius: 8px; color: var(--text-muted); font-size: 0.9rem;">
                        {{ profile.resume_text|linebreaks|truncatewords:50 }}
                    </div>
                    {% else %}
                    <p style="color: var(--text-muted);">No resume uploaded.</p>
                    {% endif %}
                </div>

                <!-- Target Roles -->
                <div class="card">
                    <h3 style="margin-bottom: 20px;">Target Roles</h3>
                    {% if profile.roles_list %}
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        {% for role in profile.roles_list %}
                             <span style="background: rgba(255, 107, 107, 0.1); color: var(--primary-color); border: 1px solid var(--primary-color); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;">{{ role }}</span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p style="color: var(--text-muted);">No target roles specified.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Right Column (Personality) -->
            <div>
                <div class="card" style="text-align: center;">
                    <h3 style="margin-bottom: 20px;">Personality Archetype</h3>
                    {% if assessment %}
                        <div id="type-badge" style="font-size: 3.5rem; font-weight: 800; color: var(--primary-color); margin-bottom: 5px; text-shadow: 0 0 20px rgba(255, 107, 107, 0.4);">
                            {{ assessment.result_type }}
                        </div>
                        <div id="type-name" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;"></div>
                        <p id="type-desc" style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.5; margin-bottom: 20px;">
                            <!-- Description injected by JS -->
                        </p>
                        <a href="{% url 'personality_test' %}" style="font-size: 0.85rem; text-decoration: underline;">Retake Test</a>
                    {% else %}
                        <p style="color: var(--text-muted); margin-bottom: 20px;">Discover your work style.</p>
                        <a href="{% url 'personality_test' %}" class="btn-primary" style="font-size: 0.9rem; padding: 10px 20px;">Take Test</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Career Paths -->
    <div id="career-paths" class="tab-content" style="display: none;">
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            {% for path in career_paths %}
            <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <h3 style="font-size: 1.2rem;">{{ path.title }}</h3>
                    <span style="font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; background: rgba(255,255,255,0.1);">{{ path.status }}</span>
                </div>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">{{ path.description|truncatewords:20 }}</p>
                
                <div style="background: #333; height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 5px;">
                    <div style="background: var(--primary-color); height: 100%; width: {{ path.progress }}%;"></div>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">{{ path.progress }}% Complete</div>
                
                <div style="display: flex; gap: 10px;">
                    <a href="{% url 'view_career_path' path.id %}" style="flex: 1; text-align: center; border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; color: var(--text-muted); text-decoration: none;">View</a>
                    <button onclick="deleteItem('path', {{ path.id }})" style="flex: 1; background: none; border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; color: #ff4444; cursor: pointer;">Delete</button>
                </div>
            </div>
            {% empty %}
            <div class="card" style="grid-column: 1/-1; text-align: center; padding: 50px;">
                <p style="color: var(--text-muted); margin-bottom: 20px;">No career paths generated yet.</p>
                <a href="{% url 'pathfinder' %}" class="btn-primary">Start Pathfinder</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Tab Content: Saved Companies -->
    <div id="companies" class="tab-content" style="display: none;">
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            {% for company in saved_companies %}
            <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <h3 style="font-size: 1.2rem;">{{ company.company_name }}</h3>
                    {% if company.compatibility_score %}
                    <span style="color: var(--primary-color); font-weight: bold;">{{ company.compatibility_score }}% Match</span>
                    {% endif %}
                </div>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px;">Saved on {{ company.date_saved|date:"M d, Y" }}</p>

                <div style="display: flex; gap: 10px;">
                    <button onclick="alert('Full report view coming soon!')" style="flex: 1; background: none; border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; color: var(--text-muted); cursor: pointer;">View Analysis</button>
                    <button onclick="deleteItem('company', {{ company.id }})" style="flex: 1; background: none; border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; color: #ff4444; cursor: pointer;">Delete</button>
                </div>
            </div>
            {% empty %}
            <div class="card" style="grid-column: 1/-1; text-align: center; padding: 50px;">
                <p style="color: var(--text-muted); margin-bottom: 20px;">No companies saved.</p>
                <a href="{% url 'home' %}#matcher" class="btn-primary">Analyze a Company</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Tab Content: Interviews -->
    <div id="interviews" class="tab-content" style="display: none;">
         <div style="max-width: 800px; margin: 0 auto;">
            {% for interview in interviews %}
            <div style="position: relative; padding-left: 30px; margin-bottom: 30px; border-left: 2px solid var(--border-color);">
                <div style="position: absolute; left: -9px; top: 0; width: 16px; height: 16px; background: var(--background-dark); border: 2px solid var(--primary-color); border-radius: 50%;"></div>
                
                <div class="card" style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <h3 style="font-size: 1.1rem;">{{ interview.company_name }}</h3>
                        <span style="font-size: 0.8rem; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px;">{{ interview.get_interview_type_display }}</span>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px;">{{ interview.date_logged|date:"F j, Y, P" }}</p>
                    {% if interview.notes %}
                        <div style="background: var(--background-input); padding: 10px; border-radius: 6px; font-size: 0.9rem; color: var(--text-main);">
                            <strong>Notes:</strong> {{ interview.notes }}
                        </div>
                    {% endif %}
                    <button onclick="deleteItem('interview', {{ interview.id }})" style="background: none; border: none; color: #ff4444; font-size: 0.85rem; margin-top: 10px; cursor: pointer; text-decoration: underline;">Remove</button>
                </div>
            </div>
            {% empty %}
            <div class="card" style="text-align: center; padding: 50px;">
                <p style="color: var(--text-muted); margin-bottom: 20px;">No interviews logged.</p>
                <a href="{% url 'interview_prep' %}" class="btn-primary">Prep for Interview</a>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<script>
    // Tab Logic
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
            tablinks[i].style.color = "var(--text-muted)";
            tablinks[i].style.borderBottom = "none";
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
        evt.currentTarget.style.color = "var(--primary-color)";
        evt.currentTarget.style.borderBottom = "2px solid var(--primary-color)";
    }

    // Delete Logic
    function deleteItem(type, id) {
        if (confirm('Are you sure you want to delete this item?')) {
            fetch(`/profile/delete/${type}/${id}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error deleting item');
                }
            });
        }
    }

    // Personality Map
    const types = {
        "INTJ": { name: "The Architect", desc: "Imaginative and strategic thinkers, with a plan for everything." },
        "INTP": { name: "The Logician", desc: "Innovative inventors with an unquenchable thirst for knowledge." },
        "ENTJ": { name: "The Commander", desc: "Bold, imaginative and strong-willed leaders." },
        "ENTP": { name: "The Debater", desc: "Smart and curious thinkers who cannot resist an intellectual challenge." },
        "INFJ": { name: "The Advocate", desc: "Quiet and mystical, yet very inspiring and tireless idealists." },
        "INFP": { name: "The Mediator", desc: "Poetic, kind and altruistic people, always eager to help a good cause." },
        "ENFJ": { name: "The Protagonist", desc: "Charismatic and inspiring leaders, able to mesmerize their listeners." },
        "ENFP": { name: "The Campaigner", desc: "Enthusiastic, creative and sociable free spirits." },
        "ISTJ": { name: "The Logistician", desc: "Practical and fact-minded individuals, whose reliability cannot be doubted." },
        "ISFJ": { name: "The Defender", desc: "Very dedicated and warm protectors, always ready to defend their loved ones." },
        "ESTJ": { name: "The Executive", desc: "Excellent administrators, unsurpassed at managing things - or people." },
        "ESFJ": { name: "The Consul", desc: "Extraordinarily caring, social and popular people, always eager to help." },
        "ISTP": { name: "The Virtuoso", desc: "Bold and practical experimenters, masters of all kinds of tools." },
        "ISFP": { name: "The Adventurer", desc: "Flexible and charming artists, always ready to explore and experience something new." },
        "ESTP": { name: "The Entrepreneur", desc: "Smart, energetic and very perceptive people, who truly enjoy living on the edge." },
        "ESFP": { name: "The Entertainer", desc: "Spontaneous, energetic and enthusiastic people - life is never boring around them." }
    };

    const userType = "{{ assessment.result_type }}";
    if (userType && types[userType]) {
        document.getElementById('type-name').innerText = types[userType].name;
        document.getElementById('type-desc').innerText = types[userType].desc;
    }
</script>
{% endblock %}