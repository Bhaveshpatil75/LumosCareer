{% extends 'base.html' %}

{% block title %}Your Compatibility Report | Lumos Career{% endblock %}

{% block content %}
<div class="pathfinder-container">
    <h1>Your Career Compass Report</h1>
    {% if company_name %}
    <h2 style="color: var(--primary-color); margin-top: 10px;">Target: {{ company_name }}</h2>
    {% endif %}
</div>
<!-- templates/report.html -->

<div class="pathfinder-container" style="margin-top: 0;">
    {% if show_score %}
    <div class="ats-dashboard" style="box-shadow: none; border: none; padding: 0; background: transparent;">
        <div class="ats-header">
            <h2><span class="icon">üìä</span> ATS Analysis</h2>
            <p>Mathematical breakdown of your resume vs. job description</p>
        </div>

        <div class="ats-grid">
            <!-- Card 1: The Score -->
            <div class="ats-card score-card">
                <h3>Match Score</h3>
                <div class="score-circle-large" data-score="{{ similarity_score }}">
                    <div class="inner-circle">
                        <span class="score-number">{{ similarity_score }}%</span>
                    </div>
                </div>
                <p class="score-label">Relevance Probability</p>
            </div>

            <!-- Card 2: Matching Keywords -->
            <div class="ats-card keyword-card">
                <h3>‚úÖ Matched Keywords</h3>
                <div class="keyword-cloud">
                    {% for word in matching_keywords %}
                    <span class="tag match">{{ word }}</span>
                    {% empty %}
                    <span class="empty-state">No exact keyword matches found.</span>
                    {% endfor %}
                </div>
            </div>

            <!-- Card 3: Missing Keywords -->
            <div class="ats-card keyword-card">
                <h3>‚ö†Ô∏è Missing Keywords</h3>
                <div class="keyword-cloud">
                    {% for word in missing_keywords %}
                    <span class="tag missing">{{ word }}</span>
                    {% empty %}
                    <span class="empty-state">Great job! No major keywords missing.</span>
                    {% endfor %}
                </div>
            </div>

            <!-- Apriori Insight -->
            {% if skill_recommendations %}
            <div class="ats-card"
                style="grid-column: 1 / -1; background: rgba(var(--color-accent-rgb), 0.05); border-color: rgba(var(--color-accent-rgb), 0.2);">
                <h3>üß† Skill Synergy Suggestions</h3>
                <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 10px;">
                    We detected a pattern using <strong>Association Rule Mining</strong>. High-performing candidates
                    with your profile typically add these complementary skills:
                </p>
                <div class="keyword-cloud">
                    {% for rule in skill_recommendations %}
                    <div class="tag synergy-tag">
                        <span>{{ rule.to }}</span>
                        <span class="synergy-confidence">{{ rule.confidence }}% Confidence</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="report-content" style="box-shadow: none; border: none; padding: 0; background: transparent;">
        {{ report_content | safe | linebreaks }}
    </div>

    <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
        <a href="{% url 'home' %}"
            style="padding: 12px 20px; background-color: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); text-decoration: none; border-radius: 8px; font-weight: 600;">
            Run a New Report
        </a>

        <button id="saveCompanyBtn" onclick="saveCompanyToProfile()"
            style="padding: 12px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            Save to Profile
        </button>
    </div>
</div>

<script>
    function saveCompanyToProfile() {
        const btn = document.getElementById('saveCompanyBtn');
        const companyName = "{{ company_name|escapejs }}";
        const score = "{{ similarity_score|default:'' }}";
        // Get content from the rendered block if trying to save full report, 
        // OR rely on what was in context. 
        // Here we will try to grab the raw content if possible or just what is rendered.
        // A better approach is to send what we have.
        // Since 'report_content' variable might be huge and contain HTML, we can try to send it.
        const reportContent = `{{ report_content|escapejs }}`;

        btn.disabled = true;
        btn.innerText = 'Saving...';

        const formData = new FormData();
        formData.append('company_name', companyName);
        formData.append('compatibility_score', score);
        formData.append('report_content', reportContent);

        fetch('{% url "save_company" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    btn.innerText = 'Saved ‚úì';
                    btn.style.backgroundColor = '#4CAF50';
                } else {
                    btn.innerText = 'Save to Profile';
                    btn.disabled = false;
                    alert(data.error || 'Failed to save');
                }
            })
            .catch(err => {
                console.error(err);
                btn.innerText = 'Error';
                btn.disabled = false;
            });
    }
</script>

<style>
    .synergy-tag {
        background: rgba(var(--color-accent-rgb), 0.15);
        border: 1px solid var(--color-accent);
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        padding: 5px 12px;
    }

    .synergy-confidence {
        font-size: 0.7em;
        opacity: 0.9;
        margin-top: 2px;
    }
</style>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const scoreCircles = document.querySelectorAll('.score-circle-large');
        scoreCircles.forEach(circle => {
            const score = circle.getAttribute('data-score');
            if (score) {
                circle.style.background = `conic-gradient(var(--primary-color) ${score}%, #333 0)`;
            }
        });
    });
</script>
{% endblock %}