{% extends 'base.html' %}
{% load static %}

{% block title %}{{ path.title }} | Lumos Career{% endblock %}

{% block content %}
<div class="result-container path-view-wrapper">
    <!-- Header -->
    <div class="path-header glass-card">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <a href="{% url 'career_library' %}" class="back-link">
                    ‚Üê Back to Library
                </a>
                <h1 class="path-title">{{ path.title }}</h1>
                <p class="path-description">
                    {{ path.description }}
                </p>
            </div>

            <div class="text-end">
                <div class="progress-circle dynamic-gradient" data-progress="{{ path.progress }}">
                    <div class="inner-circle">
                        {{ path.progress }}%
                    </div>
                </div>
                <span class="progress-label">Completion</span>
            </div>
        </div>

        <div class="action-buttons mt-4 d-flex gap-3">
             {% if not is_saved_path %}
            <button onclick="startPath('{{ path.id }}')" class="btn-primary start-btn">
                Start this Path <i class="fas fa-rocket ms-2"></i>
            </button>
            <span class="text-muted small align-self-center ms-2">Add to profile to track progress</span>
            {% else %}
            <div class="badge bg-success p-3 rounded-pill px-4 fs-6 shadow-sm">
                <i class="fas fa-check-circle me-2"></i> Active Path
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Timeline/Roadmap -->
    <div class="path-roadmap-container">
        <h2 class="journey-header">Your Journey Map</h2>
        
        {% if not path.roadmap_data.steps %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i> No steps found for this path. This path might be using an old data format.
        </div>
        {% endif %}

        <div class="timeline">
            {% for step in path.roadmap_data.steps %}
            <div class="timeline-item {% if step.status == 'locked' %}locked-step{% endif %}">
                
                <!-- Connector Dot -->
                <div class="timeline-dot status-{{ step.status }}">
                    {% if step.status == 'completed' %}
                        <!-- Solid Green Circle for Completed -->
                        <div style="width: 100%; height: 100%; border-radius: 50%; background: var(--color-success);"></div>
                    {% elif step.status == 'locked' %}
                        <i class="fas fa-lock text-black-50" style="font-size: 0.7rem;"></i>
                    {% endif %}
                </div>

                <!-- Clickable Card leading to Detail View -->
                <a href="{% url 'career_step_detail' path.id step.step_id %}" class="card-link-wrapper" style="text-decoration: none; display: block; color: inherit;">
                    <div class="glass-card timeline-content step-card-hover">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="step-type">Step {{ step.step_id }}</span>
                            
                            <div class="d-flex gap-2 align-items-center">
                                {% if step.duration %}
                                <span class="badge bg-secondary bg-opacity-25 text-light fw-normal">
                                    <i class="far fa-clock me-1"></i> {{ step.duration }}
                                </span>
                                {% endif %}
                                <span class="status-badge status-{{ step.status }}">{{ step.status }}</span>
                            </div>
                        </div>

                        <h3 class="step-title">{{ step.name }}</h3>
                        <p class="step-desc text-truncate-2">{{ step.description|truncatechars:120 }}</p>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="btn-text-primary">
                                {% if step.status == 'locked' %}
                                    <i class="fas fa-lock me-1"></i> Locked
                                {% else %}
                                    View Details & Resources <i class="fas fa-arrow-right ms-1"></i>
                                {% endif %}
                            </span>

                            <!-- Direct Action Button on Card (Stop Propagation to prevent double click if using JS, but href is safest) -->
                            {% if is_saved_path and step.status == 'open' %}
                            <object> <!-- Use object to nest interactive element inside anchor validly -->
                                <button onclick="event.preventDefault(); markAsDone('{{ path.id }}', '{{ step.step_id }}')" 
                                    class="btn btn-outline-success btn-sm rounded-pill px-3 position-relative z-2">
                                    <i class="fas fa-check me-1"></i> Mark Done
                                </button>
                            </object>
                            {% endif %}
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    :root {
        --color-success-custom: #28a745; /* Explicit Green */
        --color-teal-custom: #4C9196;   /* Explicit Teal */
    }

    .path-view-wrapper {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px 20px;
        padding-bottom: 100px;
    }

    .glass-card {
        background: rgba(30, 30, 30, 0.6);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s, border-color 0.2s, background 0.2s;
    }

    .step-card-hover:hover {
        transform: translateY(-5px);
        background: rgba(40, 40, 40, 0.8);
        border-color: rgba(76, 145, 150, 0.4);
    }

    .path-header {
        margin-bottom: 50px;
        padding: 40px;
    }

    .back-link {
        text-decoration: none;
        color: var(--text-muted);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 20px;
        transition: color 0.2s;
    }
    .back-link:hover { color: #fff; }

    .path-title {
        font-size: 2.5rem;
        margin-bottom: 10px;
        color: #ffffff; /* Solid White for visibility */
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5); /* Add shadow for depth */
    }

    .path-description {
        font-size: 1.1rem;
        color: var(--text-secondary);
        max-width: 700px;
        line-height: 1.6;
    }

    /* Progress Circle */
    .progress-circle {
        width: 80px;
        height: 80px;
        position: relative;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        background: #222; 
    }
    
    .dynamic-gradient {
        /* JS updates this, but baseline */
        background: conic-gradient(#28a745 0%, #333 0%);
    }

    .inner-circle {
        width: 70%;
        height: 70%;
        background: #121212;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #fff;
        z-index: 2;
    }

    .progress-label {
        display: block;
        margin-top: 10px;
        font-size: 0.8rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* START BTN - TEAL */
    .start-btn {
        padding: 15px 40px;
        border-radius: 50px !important;
        font-weight: 700;
        font-size: 1.1rem;
        background-color: #4C9196 !important; /* Teal */
        border: none !important;
        color: white !important;
        box-shadow: 0 4px 15px rgba(76, 145, 150, 0.4);
        transition: transform 0.2s, box-shadow 0.2s;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .start-btn:hover { 
        transform: scale(1.05); 
        box-shadow: 0 6px 20px rgba(76, 145, 150, 0.6);
        background-color: #3A6F73 !important; /* Darker Teal */
        color: white !important;
    }

    .journey-header {
        margin-bottom: 40px;
        padding-left: 20px;
        border-left: 4px solid #4C9196;
        color: #fff;
    }

    /* Timeline Styles */
    .timeline {
        position: relative;
        padding-left: 40px;
        border-left: 2px solid rgba(255, 255, 255, 0.08); 
    }

    .timeline-item {
        position: relative;
        margin-bottom: 40px;
        transition: opacity 0.3s;
    }

    .timeline-dot {
        position: absolute;
        left: -51px; 
        top: 25px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #121212;
        border: 2px solid rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
        transition: all 0.3s;
        overflow: hidden; 
    }
    
    .timeline-item:hover .timeline-dot {
        border-color: #4C9196;
        box-shadow: 0 0 10px rgba(76, 145, 150, 0.3);
    }
    
    /* COMPLETED DOT - GREEN FILLED */
    .timeline-dot.status-completed {
        background-color: #28a745 !important; 
        border-color: #28a745 !important;
        box-shadow: 0 0 15px rgba(40, 167, 69, 0.5) !important;
    }
    
    .timeline-dot.status-open {
        background-color: #4C9196 !important; 
        border-color: #4C9196 !important;
        box-shadow: 0 0 15px rgba(76, 145, 150, 0.4); 
    }

    .timeline-content {
        padding: 30px;
        transition: transform 0.2s, border-color 0.2s;
    }

    .step-type {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        color: var(--text-muted);
    }

    .status-badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 4px;
        text-transform: uppercase;
        font-weight: 600;
        border: 1px solid transparent;
    }

    /* COMPLETED TEXT - GREEN */
    .status-badge.status-completed {
        color: #28a745 !important;
        background-color: rgba(40, 167, 69, 0.15) !important;
        border-color: #28a745 !important;
    }

    .status-badge.status-open {
        color: #fff;
        background-color: #4C9196 !important;
    }

    .status-badge.status-locked {
        color: #ccc;
        background: rgba(255, 255, 255, 0.1);
    }

    .step-title {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: #fff;
        font-weight: 600;
    }

    .step-desc {
        color: var(--text-secondary);
        line-height: 1.6;
    }

    .step-desc.text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .btn-text-primary {
        color: #4C9196 !important;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .locked-step {
        opacity: 0.6;
        pointer-events: none; 
    }

    /* Force all buttons to match theme: Teal background, White Text, Rounded */
    button, .btn, .btn-primary, .btn-outline-success, .btn-secondary {
        border-radius: 50px !important;
        background-color: #4C9196 !important;
        color: #ffffff !important;
        border: none !important;
    }
    
    button:hover, .btn:hover, .btn-primary:hover, .btn-outline-success:hover, .btn-secondary:hover {
        background-color: #3A6F73 !important; /* Darker Teal */
        color: #ffffff !important;
        box-shadow: 0 4px 12px rgba(76, 145, 150, 0.3) !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const circles = document.querySelectorAll('.dynamic-gradient');
        circles.forEach(circle => {
            const progress = circle.getAttribute('data-progress');
            // Explicit Green Hex Code
            circle.style.background = `conic-gradient(#28a745 0% ${progress}%, #333 ${progress}% 100%)`;
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function startPath(pathId) {
        if (!confirm("Are you sure you want to start this career path? It will be added to your profile.")) return;

        fetch("{% url 'save_career_path' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrftoken
            },
            body: `path_id=${pathId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = "{% url 'profile' %}";
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(err => console.error(err));
    }

    function markAsDone(pathId, stepId) {
        fetch(`/profile/update-path/${pathId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({ mark_step_id: stepId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert("Error: " + (data.error || "Could not update progress"));
            }
        })
        .catch(err => console.error(err));
    }
</script>
{% endblock %}